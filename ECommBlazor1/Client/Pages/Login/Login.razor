@layout LoginLayout
@page "/login"

@using ECommBlazor1;
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization;
@using Microsoft.AspNetCore.Components.Web;
@using System.Net.Http;
@using System.Net.Http.Json
@using ECommBlazor1.Shared.Models;
@using ECommBlazor1.Shared.DTO;
@using System.Security.Claims;
@using ECommBlazor1.Client.Shared;

@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider CustomAuthStateProvider
@inject IAuthService Authservice

<html>
<head>
    <link rel="stylesheet" type="text/css" href="~/" />

    <title>NBS Mina Sidor</title>
</head>

<body>
        
        <EditForm Model="user" OnSubmit="LogIn">
            <div class="form-control">
                <label for="username">Enter Email...</label>
                <InputText id="email" @bind-Value="user.Email" class="form-control"/>
            </div>
            <div class="form-control">
                <label for="password">Enter Password...</label>
                <InputText id="password" @bind-Value="user.Password" type="password"/>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </EditForm>
</body>
</html>

@code {

    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    private UserDTO user = new UserDTO();

    protected async Task LogIn()
    {
        var result = await Http.PostAsJsonAsync("api/auth/login", user);

        var token = await result.Content.ReadAsStringAsync();
        Console.WriteLine(token);
        await LocalStorage.SetItemAsync("token", token);
        await CustomAuthStateProvider.GetAuthenticationStateAsync();

        NavigationManager.NavigateTo("/");

    }

    protected async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("Jwt: Token");
        await CustomAuthStateProvider.GetAuthenticationStateAsync();
    }

}
